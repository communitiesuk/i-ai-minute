name: evals tests

on:
  pull_request:
    paths:
      - "evals/**"
      - "tests/evals/**"
      - ".github/workflows/evals-test.yml"
  
  push:
    branches: [main]
    paths:
      - "evals/**"
      - "tests/evals/**"

jobs:
  evals:
    runs-on: ubuntu-latest

    defaults: 
      run: 
        working-directory: evals

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install uv 
        uses: astral-sh/setup-uv@v1
        with:
            version: "latest"
            enable-cache: true

      - name: Install dependencies
        run: uv sync
          
      - name: Run ruff lint 
        run: uv run ruff check . 
      
      - name: Run ruff format check 
        run: uv run ruff format --check . 
      
      - name: Run mypy 
        continue-on-error: true
        run: uv run mypy --pretty --error-summary

      - name: Verify package builds 
        run: uv build 

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest

      - name: Install dependencies
        working-directory: .
        run: poetry install --with dev

      - name: Run evals tests
        working-directory: .
        run: make test-evals

      - name: Upload evals coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: evals-coverage-report
          path: htmlcov/evals

